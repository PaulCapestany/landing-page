<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>bitiq graph (beta)</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#0b0f14; color:#e6edf3}
    header,footer{padding:12px 16px; background:#111827}
    .wrap{padding:16px}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:16px;max-width:980px;margin:0 auto}
    label{display:block;margin:8px 0 4px}
    input,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:#e6edf3}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    #orb{height:70vh;border-radius:12px;border:1px solid #1f2937;margin-top:16px}
    .muted{opacity:.8;font-size:12px}
    .error{color:#ff8a8a;margin-top:8px}
    .hidden{display:none}
  </style>
  <script src="https://unpkg.com/neo4j-driver@5.25.0/lib/browser/neo4j-web.min.js"></script>
  <script src="https://unpkg.com/@memgraph/orb/dist/browser/orb.min.js"></script>
  <script src="scripts/mg-relay.js"></script>
</head>
<body>
  <header><strong>bitiq graph (beta)</strong></header>
  <div class="wrap">
    <div class="card">
      <p class="muted">For quick testing. Use a <em>read-only</em> Memgraph user.</p>
      <div class="row">
        <div>
          <label>Host</label>
          <input id="host" placeholder="your-cloud-host:7687" />
        </div>
        <div>
          <label>Username</label>
          <input id="user" placeholder="readonly" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Password</label>
          <input id="pass" type="password" placeholder="••••••••" />
        </div>
        <div>
          <label>Scheme</label>
          <input id="scheme" value="bolt+s" />
        </div>
      </div>
      <label>Cypher query</label>
      <textarea id="cypher" rows="3">MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 200;</textarea>
      <button id="run">Connect & Run</button>
      <div id="err" class="error hidden"></div>
      <div id="orb"></div>
    </div>
  </div>
  <footer class="muted">Credentials are used only in your browser session. Prefer a read-only role.</footer>

  <script>
    const $ = (id) => document.getElementById(id);
    const err = (m) => { const e=$('err'); e.textContent=m; e.classList.remove('hidden'); };

    const renderGraph = (data) => {
      $('#orb').textContent = '';
      const orb = new Orb.Orb($('#orb'), { nodeStyle: { label: { visible: true } } });
      orb.data.setup(data);
      orb.controls.on();
    };

    const runDirectQuery = async ({ uri, user, pass, cypher }) => {
      let driver;
      let session;
      try {
        driver = neo4j.driver(uri, neo4j.auth.basic(user, pass), { disableLosslessIntegers: true });
        await driver.getServerInfo();

        session = driver.session();
        const res = await session.run(cypher);

        const nodes = new Map();
        const edges = [];
        const getNode = (n) => {
          const id = n.identity.toString();
          if(!nodes.has(id)){
            nodes.set(id, { id, label: Array.from(n.labels || []).join(','), data: n.properties || {} });
          }
          return nodes.get(id);
        };

        for (const r of res.records) {
          for (const v of r.values()) {
            if (v && typeof v === 'object' && v.start && v.end) {
              edges.push({ id: v.identity.toString(), source: v.start.toString(), target: v.end.toString(), label: v.type, data: v.properties || {} });
            } else if (v && v.labels) {
              getNode(v);
            }
          }
        }

        return { nodes: Array.from(nodes.values()), edges };
      } finally {
        try { await session?.close(); } catch {}
        try { await driver?.close(); } catch {}
      }
    };

    async function main() {
      $('err').classList.add('hidden');
      $('run').addEventListener('click', async () => {
        $('err').classList.add('hidden');

        const host = $('host').value.trim();
        const user = $('user').value.trim();
        const pass = $('pass').value;
        const scheme = $('scheme').value.trim() || 'bolt+s';
        const cypher = $('cypher').value;

        const hasDirectCreds = host && user && pass;
        let data;

        if (hasDirectCreds) {
          const uri = `${scheme}://${host}`;
          try {
            data = await runDirectQuery({ uri, user, pass, cypher });
          } catch (directError) {
            console.error('Direct connection failed', directError);
            const relay = prompt('Relay URL (https://relay.example.com)');
            if (!relay) {
              return err('Relay URL is required.');
            }
            try {
              data = await fetchGraph(relay, cypher);
            } catch (relayError) {
              console.error('Relay request failed', relayError);
              return err(relayError.message || 'Relay request failed.');
            }
          }
        } else {
          const relay = prompt('Relay URL (https://relay.example.com)');
          if (!relay) {
            return err('Relay URL is required.');
          }
          try {
            data = await fetchGraph(relay, cypher);
          } catch (relayError) {
            console.error('Relay request failed', relayError);
            return err(relayError.message || 'Relay request failed.');
          }
        }

        try {
          renderGraph(data);
        } catch (renderError) {
          console.error('Render failed', renderError);
          err(renderError.message || 'Unable to render graph data.');
        }
      });
    }
    main();
  </script>
</body>
</html>
